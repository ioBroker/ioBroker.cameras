"use strict";(self.webpackChunkiobroker_vis_2_widgets_camera=self.webpackChunkiobroker_vis_2_widgets_camera||[]).push([["src_SnapshotCamera_jsx","src_RtspCamera_jsx"],{52665:function(e,t,a){var n=a(15671),s=a(43144),r=a(60136),i=a(27277),o=a(15854),l=a.n(o),c=a(88411),u=function(e){(0,r.Z)(a,e);var t=(0,i.Z)(a);function a(){return(0,n.Z)(this,a),t.apply(this,arguments)}return(0,s.Z)(a,null,[{key:"getI18nPrefix",value:function(){return"cameras_"}}]),a}(window.visRxWidget||c.VisRxWidget);u.propTypes={context:l().object,themeType:l().string,style:l().object,data:l().object},t.Z=u},57003:function(e,t,a){a.r(t),a.d(t,{CameraField:function(){return x}});var n=a(15671),s=a(43144),r=a(11752),i=a(61120),o=a(60136),l=a(27277),c=a(74165),u=a(15861),d=a(29439),h=a(4819),v=a.n(h),p=a(12181),m=a(94427),f=a(59665),g=a(52665),b=a(80184),x=function(e){var t=v().useState(null),a=(0,d.Z)(t,2),n=a[0],s=a[1],r=v().useState(e.data.camera||""),i=(0,d.Z)(r,2),o=i[0],l=i[1];return(0,h.useEffect)((function(){(0,u.Z)((0,c.Z)().mark((function t(){var a;return(0,c.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=[],t.next=3,e.context.socket.getAdapterInstances("cameras");case 3:t.sent.forEach((function(t){var n=t._id.split(".").pop();t.native.cameras.filter((function(t){return!e.rtsp||"rtsp"===t.type||t.rtsp})).forEach((function(e){a.push({enabled:!1!==e.enabled,value:"".concat(n,"/").concat(e.name),label:"cameras.".concat(n,"/").concat(e.name),subLabel:"".concat(e.desc,"/").concat(e.ip)})}))})),s(a);case 6:case"end":return t.stop()}}),t)})))()}),[e.context.socket,e.rtsp]),n?(0,b.jsx)(m.Select,{fullWidth:!0,variant:"standard",value:o,onChange:function(t){e.setData({camera:t.target.value}),l(t.target.value)},children:n.map((function(e){return(0,b.jsxs)(m.MenuItem,{value:e.value,style:{display:"block",opacity:e.enabled?1:.5},children:[(0,b.jsx)("div",{children:e.label}),(0,b.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7},children:e.subLabel}),e.enabled?null:(0,b.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7,color:"red"},children:g.Z.t("disabled")})]},e.value)}))}):(0,b.jsx)(m.CircularProgress,{})},C=function(e){(0,o.Z)(a,e);var t=(0,l.Z)(a);function a(e){var s;return(0,n.Z)(this,a),(s=t.call(this,e)).updateStream=function(e,t){null!==t&&void 0!==t&&t.val&&(s.state.loading&&s.setState({loading:!1}),a.drawCamera(s.videoRef,t.val),s.state.full&&a.drawCamera(s.fullVideoRef,t.val))},s.onCameras=function(e){if(e){if("object"===typeof e&&(e.accepted||e.error))return void(e.error&&console.error(e.error));s.state.loading&&s.setState({loading:!1}),a.drawCamera(s.videoRef,e),s.state.full&&a.drawCamera(s.fullVideoRef,e)}},s.onAliveChanged=function(e,t){var n=a.getNameAndInstance(s.state.rxData.camera);if(n&&e==="system.adapter.cameras.".concat(n.instanceId,".alive")){var r=!(null===t||void 0===t||!t.val);r!==s.state.alive&&s.setState({alive:r},(function(){return s.propertiesUpdate()}))}},s.videoInterval=null,s.videoRef=v().createRef(),s.fullVideoRef=v().createRef(),s.currentCam=null,s.state.full=!1,s.state.alive=!1,s}return(0,s.Z)(a,[{key:"getWidgetInfo",value:function(){return a.getWidgetInfo()}},{key:"propertiesUpdate",value:function(){var e=(0,u.Z)((0,c.Z)().mark((function e(){var t,n,s,r,i,o,l,u,d,h,v,p,m,f,g,b;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.useMessages){e.next=4;break}return e.next=3,this.props.context.socket.checkFeatureSupported("INSTANCE_MESSAGES");case 3:this.useMessages=e.sent;case 4:if(this.state.rxData.camera===this.currentCam){e.next=44;break}if(!this.state.alive){e.next=34;break}if(!this.currentCam){e.next=17;break}if(t=a.getNameAndInstance(this.currentCam),n=t.instanceId,s=t.name,!this.useMessages){e.next=13;break}return e.next=11,this.props.context.socket.unsubscribeFromInstance("cameras.".concat(n),"startCamera/".concat(s),this.onCameras);case 11:e.next=17;break;case 13:return e.next=15,this.props.context.socket.setState("cameras.".concat(n,".").concat(s,".running"),{val:!1});case 15:return e.next=17,this.props.context.socket.unsubscribeState("cameras.".concat(n,".").concat(s,".stream"),this.updateStream);case 17:if(!this.state.rxData.camera){e.next=29;break}if(this.setState({loading:!0}),r=a.getNameAndInstance(this.state.rxData.camera),i=r.instanceId,o=r.name,!this.useMessages){e.next=25;break}return e.next=23,this.props.context.socket.subscribeOnInstance("cameras.".concat(i),"startCamera/".concat(o),{width:this.getImageWidth()},this.onCameras);case 23:e.next=27;break;case 25:return e.next=27,this.props.context.socket.subscribeState("cameras.".concat(i,".").concat(o,".stream"),this.updateStream);case 27:e.next=31;break;case 29:(l=this.videoRef.current)&&l.getContext("2d").clearRect(0,0,l.width,l.height);case 31:this.currentCam=this.state.rxData.camera,e.next=42;break;case 34:if(!this.currentCam){e.next=42;break}if(u=a.getNameAndInstance(this.currentCam),d=u.instanceId,h=u.name,this.useMessages){e.next=41;break}return e.next=39,this.props.context.socket.setState("cameras.".concat(d,".").concat(h,".running"),{val:!1});case 39:return e.next=41,this.props.context.socket.unsubscribeState("cameras.".concat(d,".").concat(h,".stream"),this.updateStream);case 41:this.currentCam=null;case 42:e.next=63;break;case 44:if(!this.currentCam||!this.state.alive){e.next=55;break}if(v=a.getNameAndInstance(this.currentCam),p=v.instanceId,m=v.name,!this.useMessages){e.next=51;break}return e.next=49,this.props.context.socket.subscribeOnInstance("cameras.".concat(p),"startCamera/".concat(m),{width:this.getImageWidth()},this.onCameras);case 49:e.next=53;break;case 51:return e.next=53,this.props.context.socket.setState("cameras.".concat(p,".").concat(m,".running"),{val:!0,expire:30});case 53:e.next=63;break;case 55:if(!this.currentCam||this.state.alive){e.next=63;break}if(f=a.getNameAndInstance(this.currentCam),g=f.instanceId,b=f.name,this.useMessages){e.next=62;break}return e.next=60,this.props.context.socket.setState("cameras.".concat(g,".").concat(b,".running"),{val:!1});case 60:return e.next=62,this.props.context.socket.unsubscribeState("cameras.".concat(g,".").concat(b,".stream"),this.updateStream);case 62:this.currentCam=null;case 63:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getImageWidth",value:function(e){var t;return(e=void 0===e?this.state.full:e)&&this.fullVideoRef.current?this.fullVideoRef.current.parentElement.clientWidth||0:(null===(t=this.videoRef.current)||void 0===t?void 0:t.parentElement.clientWidth)||0}},{key:"subscribeOnAlive",value:function(){var e=(0,u.Z)((0,c.Z)().mark((function e(){var t;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=a.getNameAndInstance(this.state.rxData.camera),this.subsribedOnAlive!==(t?t.instanceId:null)&&(this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=""),t&&(this.props.context.socket.subscribeState("system.adapter.cameras.".concat(t.instanceId,".alive"),this.onAliveChanged),this.subsribedOnAlive=t.instanceId));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentDidMount",value:function(){var e=this;(0,r.Z)((0,i.Z)(a.prototype),"componentDidMount",this).call(this),setTimeout((function(){return e.propertiesUpdate()}),100),this.subscribeOnAlive(),this.videoInterval=setInterval((function(){return e.propertiesUpdate()}),14e3)}},{key:"onRxDataChanged",value:function(){var e=(0,u.Z)((0,c.Z)().mark((function e(){return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subscribeOnAlive();case 2:return e.next=4,this.propertiesUpdate();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentWillUnmount",value:function(){if((0,r.Z)((0,i.Z)(a.prototype),"componentWillUnmount",this).call(this),this.videoInterval&&clearInterval(this.videoInterval),this.videoInterval=null,this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=null),this.currentCam){var e=a.getNameAndInstance(this.currentCam),t=e.instanceId,n=e.name;this.useMessages&&this.props.context.socket.unsubscribeFromInstance("cameras.".concat(t),"startCamera/".concat(n),this.onCameras).catch((function(e){return console.error(e)}))}}},{key:"renderDialog",value:function(){var e=this;return this.state.full?(0,b.jsxs)(m.Dialog,{fullWidth:!0,maxWidth:"lg",open:!0,onClose:function(){return e.setState({full:!1})},children:[(0,b.jsx)(m.DialogTitle,{children:this.state.rxData.widgetTitle}),(0,b.jsx)(m.DialogContent,{children:(0,b.jsx)("div",{className:this.props.classes.imageContainer,children:(0,b.jsx)("canvas",{ref:this.fullVideoRef,className:this.props.classes.fullCamera})})}),(0,b.jsx)(m.DialogActions,{children:(0,b.jsx)(m.Button,{onClick:function(t){t.stopPropagation(),t.preventDefault(),e.setState({full:!1})},startIcon:(0,b.jsx)(f.Close,{}),color:"primary",variant:"contained",children:g.Z.t("Close")})})]}):null}},{key:"renderWidgetBody",value:function(e){var t=this;(0,r.Z)((0,i.Z)(a.prototype),"renderWidgetBody",this).call(this,e);var n=(0,b.jsxs)("div",{className:this.props.classes.imageContainer,onClick:function(){return t.setState({full:!0})},children:[this.state.loading&&this.state.alive&&(0,b.jsx)(m.CircularProgress,{className:this.props.classes.progress}),this.state.alive?null:(0,b.jsx)("div",{style:{position:"absolute",top:0,left:0},children:g.Z.t("Camera instance %s inactive",(this.state.rxData.camera||"").split("/")[0])}),(0,b.jsx)("canvas",{ref:this.videoRef,className:this.props.classes.camera}),this.renderDialog()]});return this.state.rxData.noCard||e.widget.usedInWidget?n:this.wrapContent(n,null,{boxSizing:"border-box",paddingBottom:10,height:"100%"})}}],[{key:"getWidgetInfo",value:function(){return{id:"tplCameras2RtspCamera",visSet:"cameras",visName:"RTSP Camera",visWidgetLabel:"RTSP Camera",visWidgetSetLabel:"Cameras",visSetLabel:"Cameras",visSetColor:"#9f0026",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox"},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{name:"width",label:"videoWidth",type:"number",tooltip:"tooltip_videoWidth"},{label:"Camera",name:"camera",type:"custom",component:function(e,t,a,n){return(0,b.jsx)(x,{field:e,rtsp:!0,data:t,setData:a,context:n.context})}}]}],visDefaultStyle:{width:"100%",height:240,position:"relative"},visPrev:"widgets/cameras/img/prev_camera.png"}}},{key:"drawCamera",value:function(e,t){var a=e.current;if(a){var n=a.getContext("2d");try{var s=new Image;s.src="data:image/jpeg;base64,".concat(t),s.onload=function(){a.width=s.width,a.height=s.height,n.drawImage(s,0,0,s.width,s.height)},s.onerror=function(e){console.error(e)}}catch(r){console.error(r)}}}},{key:"getNameAndInstance",value:function(e){if(!e)return null;var t=e.indexOf("/");return-1===t?null:{instanceId:e.substring(0,t),name:e.substring(t+1)}}}]),a}(g.Z);t.default=(0,p.withStyles)((function(){return{camera:{width:"100%",height:"100%",objectFit:"contain",cursor:"pointer"},fullCamera:{width:"100%",height:"100%",objectFit:"contain"},imageContainer:{flex:1,overflow:"hidden",position:"relative",width:"100%",height:"100%"}}}))(C)},54779:function(e,t,a){a.r(t);var n=a(74165),s=a(15861),r=a(15671),i=a(43144),o=a(11752),l=a(61120),c=a(60136),u=a(27277),d=a(4819),h=a.n(d),v=a(12181),p=a(94427),m=a(59665),f=a(52665),g=a(57003),b=a(80184),x=function(e){(0,c.Z)(a,e);var t=(0,u.Z)(a);function a(e){var n;return(0,r.Z)(this,a),(n=t.call(this,e)).updateImage=function(){n.loading||(n.loading=!0,n.videoRef.current&&(n.videoRef.current.src=n.getUrl(),n.videoRef.current.onload=function(e){e.target&&"1"!==!e.target.style.opacity&&(e.target.style.opacity="1"),n.state.error&&n.setState({error:!1}),n.loading=!1},n.videoRef.current.onerror=function(e){e.target&&"0"!==e.target.style.opacity&&(e.target.style.opacity="0"),!n.state.error&&n.setState({error:!0}),n.loading=!1}),n.fullVideoRef.current&&n.state.full&&(n.fullVideoRef.current.src=n.getUrl(!0)))},n.onAliveChanged=function(e,t){var s=a.getNameAndInstance(n.state.rxData.camera);if(s&&e==="system.adapter.cameras.".concat(s.instanceId,".alive")){var r=!(null===t||void 0===t||!t.val);r!==n.state.alive&&n.setState({alive:r},(function(){return n.restartPollingInterval()}))}},n.videoInterval=null,n.videoRef=h().createRef(),n.fullVideoRef=h().createRef(),n.currentCam=null,n.state.full=!1,n.state.alive=!1,n.state.error=!1,n}return(0,i.Z)(a,[{key:"getWidgetInfo",value:function(){return a.getWidgetInfo()}},{key:"getImageWidth",value:function(e){var t,a;return(e=void 0===e?this.state.full:e)&&this.fullVideoRef.current?(null===(a=this.fullVideoRef.current)||void 0===a?void 0:a.parentElement.clientWidth)||0:(null===(t=this.videoRef.current)||void 0===t?void 0:t.parentElement.clientWidth)||0}},{key:"subscribeOnAlive",value:function(){var e=(0,s.Z)((0,n.Z)().mark((function e(){var t;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=a.getNameAndInstance(this.state.rxData.camera),this.subsribedOnAlive!==(t?t.instanceId:null)&&(this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=""),t&&(this.props.context.socket.subscribeState("system.adapter.cameras.".concat(t.instanceId,".alive"),this.onAliveChanged),this.subsribedOnAlive=t.instanceId));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"restartPollingInterval",value:function(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.state.alive&&(this.pollingInterval=setInterval(this.updateImage,parseInt(this.state.full?this.state.rxData.pollingIntervalFull:this.state.rxData.pollingInterval,10)||500))}},{key:"componentDidMount",value:function(){(0,o.Z)((0,l.Z)(a.prototype),"componentDidMount",this).call(this),this.subscribeOnAlive()}},{key:"onRxDataChanged",value:function(){var e=(0,s.Z)((0,n.Z)().mark((function e(){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subscribeOnAlive();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentWillUnmount",value:function(){(0,o.Z)((0,l.Z)(a.prototype),"componentWillUnmount",this).call(this),this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=null,this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=null)}},{key:"renderDialog",value:function(e){var t=this;return this.state.full?(0,b.jsxs)(p.Dialog,{fullWidth:!0,maxWidth:"lg",open:!0,onClose:function(){return t.setState({full:!1},(function(){return t.restartPollingInterval()}))},children:[(0,b.jsx)(p.DialogTitle,{children:this.state.rxData.widgetTitle}),(0,b.jsx)(p.DialogContent,{children:(0,b.jsx)("div",{className:this.props.classes.imageContainer,children:(0,b.jsx)("img",{src:e,ref:this.fullVideoRef,className:this.props.classes.fullCamera,alt:this.state.rxData.camera})})}),(0,b.jsx)(p.DialogActions,{children:(0,b.jsx)(p.Button,{onClick:function(e){e.stopPropagation(),e.preventDefault(),t.setState({full:!1},(function(){return t.restartPollingInterval()}))},startIcon:(0,b.jsx)(m.Close,{}),color:"primary",variant:"contained",children:f.Z.t("Close")})})]}):null}},{key:"getUrl",value:function(e){return this.state.rxData.camera?"../cameras.".concat(this.state.rxData.camera,"?")+["ts=".concat(Date.now()),"w=".concat(this.getImageWidth(e)),"noCache=".concat(!!e&&this.state.rxData.noCacheByFull),this.state.rxData.rotate?"angle=".concat(this.state.rxData.rotate):""].filter((function(e){return e})).join(""):""}},{key:"renderWidgetBody",value:function(e){var t=this;(0,o.Z)((0,l.Z)(a.prototype),"renderWidgetBody",this).call(this,e);var n=this.getUrl(),s=(0,b.jsxs)("div",{className:this.props.classes.imageContainer,onClick:function(){return!t.state.error&&t.setState({full:!0},(function(){return t.restartPollingInterval()}))},children:[this.state.alive?null:(0,b.jsx)("div",{style:{position:"absolute",top:20,left:0},children:f.Z.t("Camera instance %s inactive",(this.state.rxData.camera||"").split("/")[0])}),n?(0,b.jsx)("img",{src:n,ref:this.videoRef,className:this.props.classes.camera,alt:this.state.rxData.camera}):f.Z.t("No camera selected"),this.state.alive&&this.state.error?(0,b.jsxs)("div",{style:{position:"absolute",top:20,left:0},children:[(0,b.jsxs)("div",{style:{color:"red"},children:[f.Z.t("Cannot load URL"),":"]}),(0,b.jsx)("div",{children:this.getUrl(!0)})]}):null,this.renderDialog(n)]});return this.state.rxData.noCard||e.widget.usedInWidget?s:this.wrapContent(s,null,{boxSizing:"border-box",paddingBottom:10,height:"100%"})}}],[{key:"getWidgetInfo",value:function(){return{id:"tplCameras2SnapshotCamera",visSet:"cameras",visName:"Polling Camera",visWidgetLabel:"Polling Camera",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox"},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{name:"pollingInterval",label:"pollingInterval",tooltip:"tooltip_ms",type:"number",default:500},{name:"pollingIntervalFull",label:"pollingIntervalFull",tooltip:"tooltip_ms",type:"number",default:300},{name:"noCacheByFull",label:"noCacheByFull",type:"checkbox"},{name:"rotate",label:"rotate",type:"select",noTranslation:!0,options:[{value:0,label:"0\xb0"},{value:90,label:"90\xb0"},{value:180,label:"180\xb0"},{value:270,label:"270\xb0"}]},{label:"Camera",name:"camera",type:"custom",component:function(e,t,a,n){return(0,b.jsx)(g.CameraField,{field:e,data:t,setData:a,context:n.context})}}]}],visDefaultStyle:{width:"100%",height:240,position:"relative"},visPrev:"widgets/cameras/img/prev_snapshot.png"}}},{key:"getNameAndInstance",value:function(e){if(!e)return null;var t=e.indexOf("/");return-1===t?null:{instanceId:e.substring(0,t),name:e.substring(t+1)}}}]),a}(f.Z);t.default=(0,v.withStyles)((function(){return{camera:{width:"100%",height:"100%",objectFit:"contain",cursor:"pointer"},fullCamera:{width:"100%",height:"100%",objectFit:"contain"},imageContainer:{flex:1,overflow:"hidden",position:"relative",width:"100%",height:"100%"}}}))(x)}}]);
//# sourceMappingURL=src_SnapshotCamera_jsx.ef1edc89.chunk.js.map