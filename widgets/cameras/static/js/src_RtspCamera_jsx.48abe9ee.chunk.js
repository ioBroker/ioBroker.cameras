"use strict";(self.webpackChunkiobroker_vis_2_widgets_camera=self.webpackChunkiobroker_vis_2_widgets_camera||[]).push([["src_RtspCamera_jsx"],{52665:function(e,t,a){var n=a(15671),s=a(43144),r=a(60136),i=a(27277),c=a(15854),o=a.n(c),l=a(88411),u=function(e){(0,r.Z)(a,e);var t=(0,i.Z)(a);function a(){return(0,n.Z)(this,a),t.apply(this,arguments)}return(0,s.Z)(a,null,[{key:"getI18nPrefix",value:function(){return"cameras_"}}]),a}(window.visRxWidget||l.VisRxWidget);u.propTypes={context:o().object,themeType:o().string,style:o().object,data:o().object},t.Z=u},57003:function(e,t,a){a.r(t),a.d(t,{CameraField:function(){return g}});var n=a(15671),s=a(43144),r=a(11752),i=a(61120),c=a(60136),o=a(27277),l=a(74165),u=a(15861),d=a(29439),h=a(4819),m=a.n(h),p=a(58503),v=a(94427),f=a(59665),b=a(52665),x=a(80184),g=function(e){var t=m().useState(null),a=(0,d.Z)(t,2),n=a[0],s=a[1];return(0,h.useEffect)((function(){(0,u.Z)((0,l.Z)().mark((function t(){var a;return(0,l.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=[],t.next=3,e.context.socket.getAdapterInstances("cameras");case 3:t.sent.forEach((function(t){var n=t._id.split(".").pop();t.native.cameras.filter((function(t){return!e.rtsp||"rtsp"===t.type||t.rtsp})).forEach((function(e){a.push({enabled:!1!==e.enabled,value:"".concat(n,"/").concat(e.name),label:"cameras.".concat(n,"/").concat(e.name),subLabel:"".concat(e.desc,"/").concat(e.ip)})}))})),s(a);case 6:case"end":return t.stop()}}),t)})))()}),[e.context.socket,e.rtsp]),n?(0,x.jsx)(v.Select,{fullWidth:!0,variant:"standard",value:e.data.camera||"",onChange:function(t){return e.setData({camera:t.target.value})},children:n.map((function(e){return(0,x.jsxs)(v.MenuItem,{value:e.value,style:{display:"block",opacity:e.enabled?1:.5},children:[(0,x.jsx)("div",{children:e.label}),(0,x.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7},children:e.subLabel}),e.enabled?null:(0,x.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7,color:"red"},children:b.Z.t("disabled")})]},e.value)}))}):(0,x.jsx)(v.CircularProgress,{})},C=function(e){(0,c.Z)(a,e);var t=(0,o.Z)(a);function a(e){var s;return(0,n.Z)(this,a),(s=t.call(this,e)).updateStream=function(e,t){null!==t&&void 0!==t&&t.val&&(s.state.loading&&s.setState({loading:!1}),a.drawCamera(s.videoRef,t.val),s.state.full&&a.drawCamera(s.fullVideoRef,t.val))},s.onCameras=function(e){if(e){if("object"===typeof e&&(e.accepted||e.error))return void(e.error&&console.error(e.error));s.state.loading&&s.setState({loading:!1}),a.drawCamera(s.videoRef,e),s.state.full&&a.drawCamera(s.fullVideoRef,e)}},s.onAliveChanged=function(e,t){var n=a.getNameAndInstance(s.state.rxData.camera);if(n&&e==="system.adapter.cameras.".concat(n.instanceId,".alive")){var r=!(null===t||void 0===t||!t.val);r!==s.state.alive&&s.setState({alive:r},(function(){return s.propertiesUpdate()}))}},s.videoInterval=null,s.videoRef=m().createRef(),s.fullVideoRef=m().createRef(),s.currentCam=null,s.state.full=!1,s.state.alive=!1,s}return(0,s.Z)(a,[{key:"getWidgetInfo",value:function(){return a.getWidgetInfo()}},{key:"propertiesUpdate",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(){var t,n,s,r,i,c,o,u,d,h,m,p,v,f,b,x;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.useMessages){e.next=4;break}return e.next=3,this.props.context.socket.checkFeatureSupported("INSTANCE_MESSAGES");case 3:this.useMessages=e.sent;case 4:if(this.state.rxData.camera===this.currentCam){e.next=44;break}if(!this.state.alive){e.next=34;break}if(!this.currentCam){e.next=17;break}if(t=a.getNameAndInstance(this.currentCam),n=t.instanceId,s=t.name,!this.useMessages){e.next=13;break}return e.next=11,this.props.context.socket.unsubscribeFromInstance("cameras.".concat(n),"startCamera/".concat(s),this.onCameras);case 11:e.next=17;break;case 13:return e.next=15,this.props.context.socket.setState("cameras.".concat(n,".").concat(s,".running"),{val:!1});case 15:return e.next=17,this.props.context.socket.unsubscribeState("cameras.".concat(n,".").concat(s,".stream"),this.updateStream);case 17:if(!this.state.rxData.camera){e.next=29;break}if(this.setState({loading:!0}),r=a.getNameAndInstance(this.state.rxData.camera),i=r.instanceId,c=r.name,!this.useMessages){e.next=25;break}return e.next=23,this.props.context.socket.subscribeOnInstance("cameras.".concat(i),"startCamera/".concat(c),{width:this.getImageWidth()},this.onCameras);case 23:e.next=27;break;case 25:return e.next=27,this.props.context.socket.subscribeState("cameras.".concat(i,".").concat(c,".stream"),this.updateStream);case 27:e.next=31;break;case 29:(o=this.videoRef.current)&&o.getContext("2d").clearRect(0,0,o.width,o.height);case 31:this.currentCam=this.state.rxData.camera,e.next=42;break;case 34:if(!this.currentCam){e.next=42;break}if(u=a.getNameAndInstance(this.currentCam),d=u.instanceId,h=u.name,this.useMessages){e.next=41;break}return e.next=39,this.props.context.socket.setState("cameras.".concat(d,".").concat(h,".running"),{val:!1});case 39:return e.next=41,this.props.context.socket.unsubscribeState("cameras.".concat(d,".").concat(h,".stream"),this.updateStream);case 41:this.currentCam=null;case 42:e.next=63;break;case 44:if(!this.currentCam||!this.state.alive){e.next=55;break}if(m=a.getNameAndInstance(this.currentCam),p=m.instanceId,v=m.name,!this.useMessages){e.next=51;break}return e.next=49,this.props.context.socket.subscribeOnInstance("cameras.".concat(p),"startCamera/".concat(v),{width:this.getImageWidth()},this.onCameras);case 49:e.next=53;break;case 51:return e.next=53,this.props.context.socket.setState("cameras.".concat(p,".").concat(v,".running"),{val:!0,expire:30});case 53:e.next=63;break;case 55:if(!this.currentCam||this.state.alive){e.next=63;break}if(f=a.getNameAndInstance(this.currentCam),b=f.instanceId,x=f.name,this.useMessages){e.next=62;break}return e.next=60,this.props.context.socket.setState("cameras.".concat(b,".").concat(x,".running"),{val:!1});case 60:return e.next=62,this.props.context.socket.unsubscribeState("cameras.".concat(b,".").concat(x,".stream"),this.updateStream);case 62:this.currentCam=null;case 63:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getImageWidth",value:function(){var e,t;return this.state.full?(null===(t=this.fullVideoRef.current)||void 0===t?void 0:t.parentElement.clientWidth)||0:(null===(e=this.videoRef.current)||void 0===e?void 0:e.parentElement.clientWidth)||0}},{key:"subscribeOnAlive",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(){var t;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=a.getNameAndInstance(this.state.rxData.camera),this.subsribedOnAlive!==(t?t.instanceId:null)&&(this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=""),t&&(this.props.context.socket.subscribeState("system.adapter.cameras.".concat(t.instanceId,".alive"),this.onAliveChanged),this.subsribedOnAlive=t.instanceId));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentDidMount",value:function(){var e=this;(0,r.Z)((0,i.Z)(a.prototype),"componentDidMount",this).call(this),setTimeout((function(){return e.propertiesUpdate()}),100),this.subscribeOnAlive(),this.videoInterval=setInterval((function(){return e.propertiesUpdate()}),14e3)}},{key:"onRxDataChanged",value:function(){var e=(0,u.Z)((0,l.Z)().mark((function e(){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subscribeOnAlive();case 2:return e.next=4,this.propertiesUpdate();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentWillUnmount",value:function(){if((0,r.Z)((0,i.Z)(a.prototype),"componentWillUnmount",this).call(this),this.videoInterval&&clearInterval(this.videoInterval),this.videoInterval=null,this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=null),this.currentCam){var e=a.getNameAndInstance(this.currentCam),t=e.instanceId,n=e.name;this.useMessages&&this.props.context.socket.unsubscribeFromInstance("cameras.".concat(t),"startCamera/".concat(n),this.onCameras).catch((function(e){return console.error(e)}))}}},{key:"renderDialog",value:function(){var e=this;return this.state.full?(0,x.jsxs)(v.Dialog,{fullWidth:!0,maxWidth:"lg",open:!0,onClose:function(){return e.setState({full:!1})},children:[(0,x.jsx)(v.DialogTitle,{children:this.state.rxData.widgetTitle}),(0,x.jsx)(v.DialogContent,{children:(0,x.jsx)("div",{className:this.props.classes.imageContainer,children:(0,x.jsx)("canvas",{ref:this.fullVideoRef,className:this.props.classes.fullCamera})})}),(0,x.jsx)(v.DialogActions,{children:(0,x.jsx)(v.Button,{onClick:function(t){t.stopPropagation(),t.preventDefault(),e.setState({full:!1})},startIcon:(0,x.jsx)(f.Close,{}),color:"primary",variant:"contained",children:b.Z.t("Close")})})]}):null}},{key:"renderWidgetBody",value:function(e){var t=this;(0,r.Z)((0,i.Z)(a.prototype),"renderWidgetBody",this).call(this,e);var n=(0,x.jsxs)("div",{className:this.props.classes.imageContainer,onClick:function(){return t.setState({full:!0})},children:[this.state.loading&&this.state.alive&&(0,x.jsx)(v.CircularProgress,{className:this.props.classes.progress}),this.state.alive?null:(0,x.jsx)("div",{style:{position:"absolute",top:0,left:0},children:b.Z.t("Camera instance %s inactive",(this.state.rxData.camera||"").split("/")[0])}),(0,x.jsx)("canvas",{ref:this.videoRef,className:this.props.classes.camera}),this.renderDialog()]});return this.state.rxData.noCard||e.widget.usedInWidget?n:this.wrapContent(n,null,{boxSizing:"border-box",paddingBottom:10,height:"100%"})}}],[{key:"getWidgetInfo",value:function(){return{id:"tplCameras2RtspCamera",visSet:"vis-2-widgets-cameras",visName:"RTSP Camera",visWidgetLabel:"RTSP Camera",visWidgetSetLabel:"Cameras",visSetLabel:"Cameras",visSetColor:"#9f0026",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox"},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{name:"width",label:"videoWidth",type:"number",tooltip:"tooltip_videoWidth"},{label:"Camera",name:"camera",type:"custom",component:function(e,t,a,n){return(0,x.jsx)(g,{field:e,rtsp:!0,data:t,setData:a,context:n.context})}}]}],visDefaultStyle:{width:"100%",height:240,position:"relative"},visPrev:"widgets/cameras/img/prev_camera.png"}}},{key:"drawCamera",value:function(e,t){var a=e.current;if(a){var n=a.getContext("2d");try{var s=new Image;s.src="data:image/jpeg;base64,".concat(t),s.onload=function(){a.width=s.width,a.height=s.height,n.drawImage(s,0,0,s.width,s.height)},s.onerror=function(e){console.error(e)}}catch(r){console.error(r)}}}},{key:"getNameAndInstance",value:function(e){if(!e)return null;var t=e.indexOf("/");return-1===t?null:{instanceId:e.substring(0,t),name:e.substring(t+1)}}}]),a}(b.Z);t.default=(0,p.withStyles)((function(){return{camera:{width:"100%",height:"100%",objectFit:"contain",cursor:"pointer"},fullCamera:{width:"100%",height:"100%",objectFit:"contain"},imageContainer:{flex:1,overflow:"hidden",position:"relative",width:"100%",height:"100%"}}}))(C)}}]);
//# sourceMappingURL=src_RtspCamera_jsx.48abe9ee.chunk.js.map