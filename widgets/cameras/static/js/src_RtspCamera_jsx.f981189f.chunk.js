/*! For license information please see src_RtspCamera_jsx.f981189f.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkiobroker_vis_2_widgets_camera=self.webpackChunkiobroker_vis_2_widgets_camera||[]).push([["src_RtspCamera_jsx"],{6211:(t,e,a)=>{a.d(e,{A:()=>c});var s=a(5973),i=a.n(s),n=a(5301);class r extends(window.visRxWidget||n.VisRxWidget){static getI18nPrefix(){return"cameras_"}}r.propTypes={context:i().object,themeType:i().string,style:i().object,data:i().object};const c=r},3184:(t,e,a)=>{a.r(e),a.d(e,{CameraField:()=>d,default:()=>u});var s=a(8437),i=a.n(s),n=a(7085),r=a(1839),c=a(6211),o=a(579);const l={camera:{width:"100%",height:"100%",objectFit:"contain",cursor:"pointer"},fullCamera:{width:"100%",height:"100%",objectFit:"contain"},imageContainer:{flex:1,overflow:"hidden",position:"relative",width:"100%",height:"100%"}},d=t=>{const[e,a]=i().useState(null),[r,l]=i().useState(t.data[t.field.name]||"");return(0,s.useEffect)((()=>{(async()=>{const e=[];(await t.context.socket.getAdapterInstances("cameras")).forEach((a=>{const s=a._id.split(".").pop();a.native.cameras.filter((e=>!t.rtsp||"rtsp"===e.type||e.rtsp)).forEach((t=>{e.push({enabled:!1!==t.enabled,value:"".concat(s,"/").concat(t.name),label:"cameras.".concat(s,"/").concat(t.name),subLabel:t.desc?"".concat(t.desc,"/").concat(t.ip):t.ip||""})}))})),a(e)})()}),[t.context.socket,t.rtsp]),e?(0,o.jsx)(n.Select,{fullWidth:!0,variant:"standard",value:r,onChange:e=>{t.setData({[t.field.name]:e.target.value}),l(e.target.value)},children:e.map((t=>(0,o.jsxs)(n.MenuItem,{value:t.value,style:{display:"block",opacity:t.enabled?1:.5},children:[(0,o.jsx)("div",{children:t.label}),(0,o.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7},children:t.subLabel}),t.enabled?null:(0,o.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7,color:"red"},children:c.A.t("disabled")})]},t.value)))}):(0,o.jsx)(n.CircularProgress,{})};class h extends c.A{constructor(t){super(t),this.updateStream=(t,e)=>{null!==e&&void 0!==e&&e.val&&(this.state.loading&&this.setState({loading:!1}),h.drawCamera(this.videoRef,e.val),this.state.full&&h.drawCamera(this.fullVideoRef,e.val))},this.onCameras=t=>{if(t){if("object"===typeof t&&(t.accepted||t.error))return void(t.error&&console.error(t.error));this.state.loading&&this.setState({loading:!1}),h.drawCamera(this.videoRef,t),this.state.full&&h.drawCamera(this.fullVideoRef,t)}},this.onAliveChanged=(t,e)=>{const a=h.getNameAndInstance(this.state.rxData.camera);if(a&&t==="system.adapter.cameras.".concat(a.instanceId,".alive")){const t=!(null===e||void 0===e||!e.val);t!==this.state.alive&&this.setState({alive:t},(()=>this.propertiesUpdate()))}},this.videoInterval=null,this.videoRef=i().createRef(),this.fullVideoRef=i().createRef(),this.currentCam=null,this.state.full=!1,this.state.alive=!1}static getWidgetInfo(){return{id:"tplCameras2RtspCamera",visSet:"cameras",visName:"RTSP Camera",visWidgetLabel:"RTSP Camera",visWidgetSetLabel:"Cameras",visSetLabel:"Cameras",visSetColor:"#9f0026",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox"},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{name:"width",label:"videoWidth",type:"number",tooltip:"tooltip_videoWidth"},{label:"Camera",name:"camera",type:"custom",component:(t,e,a,s)=>(0,o.jsx)(d,{field:t,rtsp:!0,data:e,setData:a,context:s.context})}]}],visDefaultStyle:{width:"100%",height:240,position:"relative"},visPrev:"widgets/cameras/img/prev_camera.png"}}getWidgetInfo(){return h.getWidgetInfo()}static drawCamera(t,e){const a=t.current;if(!a)return;const s=a.getContext("2d");try{const t=new Image;t.src="data:image/jpeg;base64,".concat(e),t.onload=()=>{a.width=t.width,a.height=t.height,s.drawImage(t,0,0,t.width,t.height)},t.onerror=t=>{console.error(t)}}catch(i){console.error(i)}}static getNameAndInstance(t){if(!t)return null;const e=t.indexOf("/");return-1===e?null:{instanceId:t.substring(0,e),name:t.substring(e+1)}}async propertiesUpdate(){if(void 0===this.useMessages&&(this.useMessages=await this.props.context.socket.checkFeatureSupported("INSTANCE_MESSAGES")),this.state.rxData.camera!==this.currentCam){if(this.state.alive){if(this.currentCam){const{instanceId:t,name:e}=h.getNameAndInstance(this.currentCam);this.useMessages?await this.props.context.socket.unsubscribeFromInstance("cameras.".concat(t),"startCamera/".concat(e),this.onCameras):(await this.props.context.socket.setState("cameras.".concat(t,".").concat(e,".running"),{val:!1}),await this.props.context.socket.unsubscribeState("cameras.".concat(t,".").concat(e,".stream"),this.updateStream))}if(this.state.rxData.camera){this.setState({loading:!0});const{instanceId:t,name:e}=h.getNameAndInstance(this.state.rxData.camera);this.useMessages?await this.props.context.socket.subscribeOnInstance("cameras.".concat(t),"startCamera/".concat(e),{width:this.getImageWidth()},this.onCameras):await this.props.context.socket.subscribeState("cameras.".concat(t,".").concat(e,".stream"),this.updateStream)}else{const t=this.videoRef.current;if(t){t.getContext("2d").clearRect(0,0,t.width,t.height)}}this.currentCam=this.state.rxData.camera}else if(this.currentCam){const{instanceId:t,name:e}=h.getNameAndInstance(this.currentCam);this.useMessages||(await this.props.context.socket.setState("cameras.".concat(t,".").concat(e,".running"),{val:!1}),await this.props.context.socket.unsubscribeState("cameras.".concat(t,".").concat(e,".stream"),this.updateStream)),this.currentCam=null}}else if(this.currentCam&&this.state.alive){const{instanceId:t,name:e}=h.getNameAndInstance(this.currentCam);this.useMessages?await this.props.context.socket.subscribeOnInstance("cameras.".concat(t),"startCamera/".concat(e),{width:this.getImageWidth()},this.onCameras):await this.props.context.socket.setState("cameras.".concat(t,".").concat(e,".running"),{val:!0,expire:30})}else if(this.currentCam&&!this.state.alive){const{instanceId:t,name:e}=h.getNameAndInstance(this.currentCam);this.useMessages||(await this.props.context.socket.setState("cameras.".concat(t,".").concat(e,".running"),{val:!1}),await this.props.context.socket.unsubscribeState("cameras.".concat(t,".").concat(e,".stream"),this.updateStream)),this.currentCam=null}}getImageWidth(t){var e;return(t=void 0===t?this.state.full:t)&&this.fullVideoRef.current?this.fullVideoRef.current.parentElement.clientWidth||0:(null===(e=this.videoRef.current)||void 0===e?void 0:e.parentElement.clientWidth)||0}async subscribeOnAlive(){const t=h.getNameAndInstance(this.state.rxData.camera);this.subsribedOnAlive!==(t?t.instanceId:null)&&(this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=""),t&&(this.props.context.socket.subscribeState("system.adapter.cameras.".concat(t.instanceId,".alive"),this.onAliveChanged),this.subsribedOnAlive=t.instanceId))}componentDidMount(){super.componentDidMount(),setTimeout((()=>this.propertiesUpdate()),100),this.subscribeOnAlive(),this.videoInterval=setInterval((()=>this.propertiesUpdate()),14e3)}async onRxDataChanged(){await this.subscribeOnAlive(),await this.propertiesUpdate()}componentWillUnmount(){if(super.componentWillUnmount(),this.videoInterval&&clearInterval(this.videoInterval),this.videoInterval=null,this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState("system.adapter.cameras.".concat(this.subsribedOnAlive,".alive"),this.onAliveChanged),this.subsribedOnAlive=null),this.currentCam){const{instanceId:t,name:e}=h.getNameAndInstance(this.currentCam);this.useMessages&&this.props.context.socket.unsubscribeFromInstance("cameras.".concat(t),"startCamera/".concat(e),this.onCameras).catch((t=>console.error(t)))}}renderDialog(){return this.state.full?(0,o.jsxs)(n.Dialog,{fullWidth:!0,maxWidth:"lg",open:!0,onClose:()=>this.setState({full:!1}),children:[(0,o.jsx)(n.DialogTitle,{children:this.state.rxData.widgetTitle}),(0,o.jsx)(n.DialogContent,{children:(0,o.jsx)("div",{style:l.imageContainer,children:(0,o.jsx)("canvas",{ref:this.fullVideoRef,style:l.fullCamera})})}),(0,o.jsx)(n.DialogActions,{children:(0,o.jsx)(n.Button,{onClick:t=>{t.stopPropagation(),t.preventDefault(),this.setState({full:!1})},startIcon:(0,o.jsx)(r.Close,{}),color:"primary",variant:"contained",children:c.A.t("Close")})})]}):null}renderWidgetBody(t){super.renderWidgetBody(t);const e=(0,o.jsxs)("div",{style:l.imageContainer,onClick:()=>this.setState({full:!0}),children:[this.state.loading&&this.state.alive&&(0,o.jsx)(n.CircularProgress,{style:l.progress}),this.state.alive?null:(0,o.jsx)("div",{style:{position:"absolute",top:0,left:0},children:c.A.t("Camera instance %s inactive",(this.state.rxData.camera||"").split("/")[0])}),(0,o.jsx)("canvas",{ref:this.videoRef,style:l.camera}),this.renderDialog()]});return this.state.rxData.noCard||t.widget.usedInWidget?e:this.wrapContent(e,null,{boxSizing:"border-box",paddingBottom:10,height:"100%"})}}const u=h},1153:(t,e,a)=>{var s=a(8437),i=Symbol.for("react.element"),n=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,c=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function l(t,e,a){var s,n={},l=null,d=null;for(s in void 0!==a&&(l=""+a),void 0!==e.key&&(l=""+e.key),void 0!==e.ref&&(d=e.ref),e)r.call(e,s)&&!o.hasOwnProperty(s)&&(n[s]=e[s]);if(t&&t.defaultProps)for(s in e=t.defaultProps)void 0===n[s]&&(n[s]=e[s]);return{$$typeof:i,type:t,key:l,ref:d,props:n,_owner:c.current}}e.jsx=l,e.jsxs=l},579:(t,e,a)=>{t.exports=a(1153)}}]);
//# sourceMappingURL=src_RtspCamera_jsx.f981189f.chunk.js.map