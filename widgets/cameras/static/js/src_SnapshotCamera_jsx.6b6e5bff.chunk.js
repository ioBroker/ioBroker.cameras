/*! For license information please see src_SnapshotCamera_jsx.6b6e5bff.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkiobroker_vis_2_widgets_camera=self.webpackChunkiobroker_vis_2_widgets_camera||[]).push([["src_SnapshotCamera_jsx","node_modules_react_jsx-runtime_js-_c9180","node_modules_react_jsx-runtime_js-_c9181","node_modules_react_jsx-runtime_js-_c9182","src_RtspCamera_jsx"],{6211:(t,e,a)=>{a.d(e,{A:()=>n});var s=a(5973),i=a.n(s);class r extends window.visRxWidget{static getI18nPrefix(){return"cameras_"}}r.propTypes={context:i().object,themeType:i().string,style:i().object,data:i().object};const n=r},3184:(t,e,a)=>{a.r(e),a.d(e,{CameraField:()=>h,default:()=>u});var s=a(8437),i=a.n(s),r=a(7085),n=a(1839),l=a(6211),o=a(579);const c={camera:{width:"100%",height:"100%",objectFit:"contain",cursor:"pointer"},fullCamera:{width:"100%",height:"100%",objectFit:"contain"},imageContainer:{flex:1,overflow:"hidden",position:"relative",width:"100%",height:"100%"}},h=t=>{const[e,a]=i().useState(null),[n,c]=i().useState(t.data[t.field.name]||"");return(0,s.useEffect)((()=>{(async()=>{const e=[];(await t.context.socket.getAdapterInstances("cameras")).forEach((a=>{const s=a._id.split(".").pop();a.native.cameras.filter((e=>!t.rtsp||"rtsp"===e.type||e.rtsp)).forEach((t=>{e.push({enabled:!1!==t.enabled,value:`${s}/${t.name}`,label:`cameras.${s}/${t.name}`,subLabel:t.desc?`${t.desc}/${t.ip}`:t.ip||""})}))})),a(e)})()}),[t.context.socket,t.rtsp]),e?(0,o.jsx)(r.Select,{fullWidth:!0,variant:"standard",value:n,onChange:e=>{t.setData({[t.field.name]:e.target.value}),c(e.target.value)},children:e.map((t=>(0,o.jsxs)(r.MenuItem,{value:t.value,style:{display:"block",opacity:t.enabled?1:.5},children:[(0,o.jsx)("div",{children:t.label}),(0,o.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7},children:t.subLabel}),t.enabled?null:(0,o.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7,color:"red"},children:l.A.t("disabled")})]},t.value)))}):(0,o.jsx)(r.CircularProgress,{})};class d extends l.A{constructor(t){super(t),this.updateStream=(t,e)=>{null!==e&&void 0!==e&&e.val&&(this.state.loading&&this.setState({loading:!1}),d.drawCamera(this.videoRef,e.val),this.state.full&&d.drawCamera(this.fullVideoRef,e.val))},this.onCameras=t=>{if(t){if("object"===typeof t&&(t.accepted||t.error))return void(t.error&&console.error(t.error));this.state.loading&&this.setState({loading:!1}),d.drawCamera(this.videoRef,t),this.state.full&&d.drawCamera(this.fullVideoRef,t)}},this.onAliveChanged=(t,e)=>{const a=d.getNameAndInstance(this.state.rxData.camera);if(a&&t===`system.adapter.cameras.${a.instanceId}.alive`){const t=!(null===e||void 0===e||!e.val);t!==this.state.alive&&this.setState({alive:t},(()=>this.propertiesUpdate()))}},this.videoInterval=null,this.videoRef=i().createRef(),this.fullVideoRef=i().createRef(),this.currentCam=null,this.state.full=!1,this.state.alive=!1}static getWidgetInfo(){return{id:"tplCameras2RtspCamera",visSet:"cameras",visName:"RTSP Camera",visWidgetLabel:"RTSP Camera",visWidgetSetLabel:"Cameras",visSetLabel:"Cameras",visSetColor:"#9f0026",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox"},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{name:"width",label:"videoWidth",type:"number",tooltip:"tooltip_videoWidth"},{label:"Camera",name:"camera",type:"custom",component:(t,e,a,s)=>(0,o.jsx)(h,{field:t,rtsp:!0,data:e,setData:a,context:s.context})}]}],visDefaultStyle:{width:"100%",height:240,position:"relative"},visPrev:"widgets/cameras/img/prev_camera.png"}}getWidgetInfo(){return d.getWidgetInfo()}static drawCamera(t,e){const a=t.current;if(!a)return;const s=a.getContext("2d");try{const t=new Image;t.src=`data:image/jpeg;base64,${e}`,t.onload=()=>{a.width=t.width,a.height=t.height,s.drawImage(t,0,0,t.width,t.height)},t.onerror=t=>{console.error(t)}}catch(i){console.error(i)}}static getNameAndInstance(t){if(!t)return null;const e=t.indexOf("/");return-1===e?null:{instanceId:t.substring(0,e),name:t.substring(e+1)}}async propertiesUpdate(){if(void 0===this.useMessages&&(this.useMessages=await this.props.context.socket.checkFeatureSupported("INSTANCE_MESSAGES")),this.state.rxData.camera!==this.currentCam){if(this.state.alive){if(this.currentCam){const{instanceId:t,name:e}=d.getNameAndInstance(this.currentCam);this.useMessages?await this.props.context.socket.unsubscribeFromInstance(`cameras.${t}`,`startCamera/${e}`,this.onCameras):(await this.props.context.socket.setState(`cameras.${t}.${e}.running`,{val:!1}),await this.props.context.socket.unsubscribeState(`cameras.${t}.${e}.stream`,this.updateStream))}if(this.state.rxData.camera){this.setState({loading:!0});const{instanceId:t,name:e}=d.getNameAndInstance(this.state.rxData.camera);this.useMessages?await this.props.context.socket.subscribeOnInstance(`cameras.${t}`,`startCamera/${e}`,{width:this.getImageWidth()},this.onCameras):await this.props.context.socket.subscribeState(`cameras.${t}.${e}.stream`,this.updateStream)}else{const t=this.videoRef.current;if(t){t.getContext("2d").clearRect(0,0,t.width,t.height)}}this.currentCam=this.state.rxData.camera}else if(this.currentCam){const{instanceId:t,name:e}=d.getNameAndInstance(this.currentCam);this.useMessages||(await this.props.context.socket.setState(`cameras.${t}.${e}.running`,{val:!1}),await this.props.context.socket.unsubscribeState(`cameras.${t}.${e}.stream`,this.updateStream)),this.currentCam=null}}else if(this.currentCam&&this.state.alive){const{instanceId:t,name:e}=d.getNameAndInstance(this.currentCam);this.useMessages?await this.props.context.socket.subscribeOnInstance(`cameras.${t}`,`startCamera/${e}`,{width:this.getImageWidth()},this.onCameras):await this.props.context.socket.setState(`cameras.${t}.${e}.running`,{val:!0,expire:30})}else if(this.currentCam&&!this.state.alive){const{instanceId:t,name:e}=d.getNameAndInstance(this.currentCam);this.useMessages||(await this.props.context.socket.setState(`cameras.${t}.${e}.running`,{val:!1}),await this.props.context.socket.unsubscribeState(`cameras.${t}.${e}.stream`,this.updateStream)),this.currentCam=null}}getImageWidth(t){var e;return(t=void 0===t?this.state.full:t)&&this.fullVideoRef.current?this.fullVideoRef.current.parentElement.clientWidth||0:(null===(e=this.videoRef.current)||void 0===e?void 0:e.parentElement.clientWidth)||0}async subscribeOnAlive(){const t=d.getNameAndInstance(this.state.rxData.camera);this.subsribedOnAlive!==(t?t.instanceId:null)&&(this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState(`system.adapter.cameras.${this.subsribedOnAlive}.alive`,this.onAliveChanged),this.subsribedOnAlive=""),t&&(this.props.context.socket.subscribeState(`system.adapter.cameras.${t.instanceId}.alive`,this.onAliveChanged),this.subsribedOnAlive=t.instanceId))}componentDidMount(){super.componentDidMount(),setTimeout((()=>this.propertiesUpdate()),100),this.subscribeOnAlive(),this.videoInterval=setInterval((()=>this.propertiesUpdate()),14e3)}async onRxDataChanged(){await this.subscribeOnAlive(),await this.propertiesUpdate()}componentWillUnmount(){if(super.componentWillUnmount(),this.videoInterval&&clearInterval(this.videoInterval),this.videoInterval=null,this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState(`system.adapter.cameras.${this.subsribedOnAlive}.alive`,this.onAliveChanged),this.subsribedOnAlive=null),this.currentCam){const{instanceId:t,name:e}=d.getNameAndInstance(this.currentCam);this.useMessages&&this.props.context.socket.unsubscribeFromInstance(`cameras.${t}`,`startCamera/${e}`,this.onCameras).catch((t=>console.error(t)))}}renderDialog(){return this.state.full?(0,o.jsxs)(r.Dialog,{fullWidth:!0,maxWidth:"lg",open:!0,onClose:()=>this.setState({full:!1}),children:[(0,o.jsx)(r.DialogTitle,{children:this.state.rxData.widgetTitle}),(0,o.jsx)(r.DialogContent,{children:(0,o.jsx)("div",{style:c.imageContainer,children:(0,o.jsx)("canvas",{ref:this.fullVideoRef,style:c.fullCamera})})}),(0,o.jsx)(r.DialogActions,{children:(0,o.jsx)(r.Button,{onClick:t=>{t.stopPropagation(),t.preventDefault(),this.setState({full:!1})},startIcon:(0,o.jsx)(n.Close,{}),color:"primary",variant:"contained",children:l.A.t("Close")})})]}):null}renderWidgetBody(t){super.renderWidgetBody(t);const e=(0,o.jsxs)("div",{style:c.imageContainer,onClick:()=>this.setState({full:!0}),children:[this.state.loading&&this.state.alive&&(0,o.jsx)(r.CircularProgress,{style:c.progress}),this.state.alive?null:(0,o.jsx)("div",{style:{position:"absolute",top:0,left:0},children:l.A.t("Camera instance %s inactive",(this.state.rxData.camera||"").split("/")[0])}),(0,o.jsx)("canvas",{ref:this.videoRef,style:c.camera}),this.renderDialog()]});return this.state.rxData.noCard||t.widget.usedInWidget?e:this.wrapContent(e,null,{boxSizing:"border-box",paddingBottom:10,height:"100%"})}}const u=d},7855:(t,e,a)=>{a.r(e),a.d(e,{default:()=>u});var s=a(8437),i=a.n(s),r=a(7085),n=a(1839),l=a(6211),o=a(3184),c=a(579);const h={camera:{width:"100%",height:"100%",objectFit:"contain",cursor:"pointer"},fullCamera:{width:"100%",height:"100%",objectFit:"contain"},imageContainer:{flex:1,overflow:"hidden",position:"relative",width:"100%",height:"100%"}};class d extends l.A{constructor(t){super(t),this.updateImage=()=>{this.loading||(this.loading=!0,this.videoRef.current&&(this.videoRef.current.src=this.getUrl(),this.videoRef.current.onload=t=>{t.target&&"1"!==!t.target.style.opacity&&(t.target.style.opacity="1"),this.state.error&&this.setState({error:!1}),this.loading=!1},this.videoRef.current.onerror=t=>{t.target&&"0"!==t.target.style.opacity&&(t.target.style.opacity="0"),!this.state.error&&this.setState({error:!0}),this.loading=!1}),this.fullVideoRef.current&&this.state.full&&(this.fullVideoRef.current.src=this.getUrl(!0)))},this.onAliveChanged=(t,e)=>{const a=d.getNameAndInstance(this.state.rxData.camera);if(a&&t===`system.adapter.cameras.${a.instanceId}.alive`){const t=!(null===e||void 0===e||!e.val);t!==this.state.alive&&this.setState({alive:t},(()=>this.restartPollingInterval()))}},this.videoInterval=null,this.videoRef=i().createRef(),this.fullVideoRef=i().createRef(),this.currentCam=null,this.state.full=!1,this.state.alive=!1,this.state.error=!1}static getWidgetInfo(){return{id:"tplCameras2SnapshotCamera",visSet:"cameras",visName:"Polling Camera",visWidgetLabel:"Polling Camera",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox"},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{name:"pollingInterval",label:"pollingInterval",tooltip:"tooltip_ms",type:"number",default:500},{name:"pollingIntervalFull",label:"pollingIntervalFull",tooltip:"tooltip_ms",type:"number",default:300},{name:"noCacheByFull",label:"noCacheByFull",type:"checkbox"},{name:"rotate",label:"rotate",type:"select",noTranslation:!0,options:[{value:0,label:"0\xb0"},{value:90,label:"90\xb0"},{value:180,label:"180\xb0"},{value:270,label:"270\xb0"}]},{label:"Camera",name:"camera",type:"custom",component:(t,e,a,s)=>(0,c.jsx)(o.CameraField,{field:t,data:e,setData:a,context:s.context})},{label:"camera_in_dialog",name:"bigCamera",type:"custom",component:(t,e,a,s)=>(0,c.jsx)(o.CameraField,{field:t,data:e,setData:a,context:s.context}),hidden:"!data.camera"}]}],visDefaultStyle:{width:"100%",height:240,position:"relative"},visPrev:"widgets/cameras/img/prev_snapshot.png"}}getWidgetInfo(){return d.getWidgetInfo()}static getNameAndInstance(t){if(!t)return null;const e=t.indexOf("/");return-1===e?null:{instanceId:t.substring(0,e),name:t.substring(e+1)}}getImageWidth(t){var e,a;return(t=void 0===t?this.state.full:t)&&this.fullVideoRef.current?(null===(a=this.fullVideoRef.current)||void 0===a?void 0:a.parentElement.clientWidth)||0:(null===(e=this.videoRef.current)||void 0===e?void 0:e.parentElement.clientWidth)||0}async subscribeOnAlive(){const t=d.getNameAndInstance(this.state.rxData.camera);this.subsribedOnAlive!==(t?t.instanceId:null)&&(this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState(`system.adapter.cameras.${this.subsribedOnAlive}.alive`,this.onAliveChanged),this.subsribedOnAlive=""),t&&(this.props.context.socket.subscribeState(`system.adapter.cameras.${t.instanceId}.alive`,this.onAliveChanged),this.subsribedOnAlive=t.instanceId))}restartPollingInterval(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.state.alive&&(this.pollingInterval=setInterval(this.updateImage,parseInt(this.state.full?this.state.rxData.pollingIntervalFull:this.state.rxData.pollingInterval,10)||500))}componentDidMount(){super.componentDidMount(),this.subscribeOnAlive()}async onRxDataChanged(){await this.subscribeOnAlive()}componentWillUnmount(){super.componentWillUnmount(),this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=null,this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState(`system.adapter.cameras.${this.subsribedOnAlive}.alive`,this.onAliveChanged),this.subsribedOnAlive=null)}renderDialog(t){return this.state.full&&this.state.rxData.bigCamera&&(t=this.getUrl(!0)||t),this.state.full?(0,c.jsxs)(r.Dialog,{fullWidth:!0,maxWidth:"lg",open:!0,onClose:()=>this.setState({full:!1},(()=>this.restartPollingInterval())),children:[(0,c.jsx)(r.DialogTitle,{children:this.state.rxData.widgetTitle}),(0,c.jsx)(r.DialogContent,{children:(0,c.jsx)("div",{style:h.imageContainer,children:(0,c.jsx)("img",{src:t,ref:this.fullVideoRef,style:h.fullCamera,alt:this.state.rxData.camera})})}),(0,c.jsx)(r.DialogActions,{children:(0,c.jsx)(r.Button,{onClick:t=>{t.stopPropagation(),t.preventDefault(),this.setState({full:!1},(()=>this.restartPollingInterval()))},startIcon:(0,c.jsx)(n.Close,{}),color:"primary",variant:"contained",children:l.A.t("Close")})})]}):null}getUrl(t){if(t&&!this.state.rxData.bigCamera){return`../cameras.${this.state.rxData.bigCamera}?`+[`ts=${Date.now()}`,`w=${this.getImageWidth(!0)}`,`noCache=${this.state.rxData.noCacheByFull}`,this.state.rxData.rotate?`angle=${this.state.rxData.rotate}`:""].filter((t=>t)).join("&")}if(this.state.rxData.camera){return`../cameras.${this.state.rxData.camera}?`+[`ts=${Date.now()}`,`w=${this.getImageWidth(t)}`,`noCache=${!!t&&this.state.rxData.noCacheByFull}`,this.state.rxData.rotate?`angle=${this.state.rxData.rotate}`:""].filter((t=>t)).join("&")}return""}renderWidgetBody(t){super.renderWidgetBody(t);const e=this.getUrl(),a=(0,c.jsxs)("div",{style:h.imageContainer,onClick:()=>!this.state.error&&this.setState({full:!0},(()=>this.restartPollingInterval())),children:[this.state.alive?null:(0,c.jsx)("div",{style:{position:"absolute",top:20,left:0},children:l.A.t("Camera instance %s inactive",(this.state.rxData.camera||"").split("/")[0])}),e?(0,c.jsx)("img",{src:e,ref:this.videoRef,style:h.camera,alt:this.state.rxData.camera}):l.A.t("No camera selected"),this.state.alive&&this.state.error?(0,c.jsxs)("div",{style:{position:"absolute",top:20,left:0},children:[(0,c.jsxs)("div",{style:{color:"red"},children:[l.A.t("Cannot load URL"),":"]}),(0,c.jsx)("div",{children:this.getUrl(!0)})]}):null,this.renderDialog(e)]});return this.state.rxData.noCard||t.widget.usedInWidget?a:this.wrapContent(a,null,{boxSizing:"border-box",paddingBottom:10,height:"100%"})}}const u=d},1153:(t,e,a)=>{var s=a(8437),i=Symbol.for("react.element"),r=Symbol.for("react.fragment"),n=Object.prototype.hasOwnProperty,l=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function c(t,e,a){var s,r={},c=null,h=null;for(s in void 0!==a&&(c=""+a),void 0!==e.key&&(c=""+e.key),void 0!==e.ref&&(h=e.ref),e)n.call(e,s)&&!o.hasOwnProperty(s)&&(r[s]=e[s]);if(t&&t.defaultProps)for(s in e=t.defaultProps)void 0===r[s]&&(r[s]=e[s]);return{$$typeof:i,type:t,key:c,ref:h,props:r,_owner:l.current}}e.jsx=c,e.jsxs=c},579:(t,e,a)=>{t.exports=a(1153)}}]);
//# sourceMappingURL=src_SnapshotCamera_jsx.6b6e5bff.chunk.js.map