/*! For license information please see src_RtspCamera_jsx.e9338218.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkiobroker_vis_2_widgets_camera=self.webpackChunkiobroker_vis_2_widgets_camera||[]).push([["src_RtspCamera_jsx","node_modules_react_jsx-runtime_js-_c9180","node_modules_react_jsx-runtime_js-_c9181","node_modules_react_jsx-runtime_js-_c9182"],{6211:(e,t,s)=>{s.d(t,{A:()=>n});var a=s(5973),i=s.n(a);class r extends window.visRxWidget{static getI18nPrefix(){return"cameras_"}}r.propTypes={context:i().object,themeType:i().string,style:i().object,data:i().object};const n=r},3184:(e,t,s)=>{s.r(t),s.d(t,{CameraField:()=>d,default:()=>u});var a=s(8437),i=s.n(a),r=s(7085),n=s(1839),o=s(6211),c=s(579);const l={camera:{width:"100%",height:"100%",objectFit:"contain",cursor:"pointer"},fullCamera:{width:"100%",height:"100%",objectFit:"contain"},imageContainer:{flex:1,overflow:"hidden",position:"relative",width:"100%",height:"100%"}},d=e=>{const[t,s]=i().useState(null),[n,l]=i().useState(e.data[e.field.name]||"");return(0,a.useEffect)((()=>{(async()=>{const t=[];(await e.context.socket.getAdapterInstances("cameras")).forEach((s=>{const a=s._id.split(".").pop();s.native.cameras.filter((t=>!e.rtsp||"rtsp"===t.type||t.rtsp)).forEach((e=>{t.push({enabled:!1!==e.enabled,value:`${a}/${e.name}`,label:`cameras.${a}/${e.name}`,subLabel:e.desc&&e.ip?`${e.desc}/${e.ip}`:e.desc||e.ip||""})}))})),s(t)})()}),[e.context.socket,e.rtsp]),t?(0,c.jsx)(r.Select,{fullWidth:!0,variant:"standard",value:n,onChange:t=>{e.setData({[e.field.name]:t.target.value}),l(t.target.value)},children:t.map((e=>(0,c.jsxs)(r.MenuItem,{value:e.value,style:{display:"block",opacity:e.enabled?1:.5},children:[(0,c.jsx)("div",{children:e.label}),e.subLabel?(0,c.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7},children:e.subLabel}):null,e.enabled?null:(0,c.jsx)("div",{style:{fontSize:10,fontStyle:"italic",opacity:.7,color:"red"},children:o.A.t("disabled")})]},e.value)))}):(0,c.jsx)(r.CircularProgress,{})};class h extends o.A{constructor(e){super(e),this.updateStream=(e,t)=>{null!==t&&void 0!==t&&t.val&&(this.state.loading&&this.setState({loading:!1}),h.drawCamera(this.videoRef,t.val),this.state.full&&h.drawCamera(this.fullVideoRef,t.val))},this.onCameras=e=>{if(e){if("object"===typeof e&&(e.accepted||e.error))return void(e.error&&console.error(e.error));this.state.loading&&this.setState({loading:!1}),h.drawCamera(this.videoRef,e),this.state.full&&h.drawCamera(this.fullVideoRef,e)}},this.onAliveChanged=(e,t)=>{const s=h.getNameAndInstance(this.state.rxData.camera);if(s&&e===`system.adapter.cameras.${s.instanceId}.alive`){const e=!(null===t||void 0===t||!t.val);e!==this.state.alive&&this.setState({alive:e},(()=>this.propertiesUpdate()))}},this.videoInterval=null,this.videoRef=i().createRef(),this.fullVideoRef=i().createRef(),this.currentCam=null,this.state.full=!1,this.state.alive=!1}static getWidgetInfo(){return{id:"tplCameras2RtspCamera",visSet:"cameras",visName:"RTSP Camera",visWidgetLabel:"RTSP Camera",visWidgetSetLabel:"Cameras",visSetLabel:"Cameras",visSetColor:"#9f0026",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox"},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{name:"width",label:"videoWidth",type:"number",tooltip:"tooltip_videoWidth"},{label:"Camera",name:"camera",type:"custom",component:(e,t,s,a)=>(0,c.jsx)(d,{field:e,rtsp:!0,data:t,setData:s,context:a.context})}]}],visDefaultStyle:{width:"100%",height:240,position:"relative"},visPrev:"widgets/cameras/img/prev_camera.png"}}getWidgetInfo(){return h.getWidgetInfo()}static drawCamera(e,t){const s=e.current;if(!s)return;const a=s.getContext("2d");try{const e=new Image;e.src=`data:image/jpeg;base64,${t}`,e.onload=()=>{s.width=e.width,s.height=e.height,a.drawImage(e,0,0,e.width,e.height)},e.onerror=e=>{console.error(e)}}catch(i){console.error(i)}}static getNameAndInstance(e){if(!e)return null;const t=e.indexOf("/");return-1===t?null:{instanceId:e.substring(0,t),name:e.substring(t+1)}}async propertiesUpdate(){if(void 0===this.useMessages&&(this.useMessages=await this.props.context.socket.checkFeatureSupported("INSTANCE_MESSAGES")),this.state.rxData.camera!==this.currentCam){if(this.state.alive){if(this.currentCam){const{instanceId:e,name:t}=h.getNameAndInstance(this.currentCam);this.useMessages?await this.props.context.socket.unsubscribeFromInstance(`cameras.${e}`,`startCamera/${t}`,this.onCameras):(await this.props.context.socket.setState(`cameras.${e}.${t}.running`,{val:!1}),await this.props.context.socket.unsubscribeState(`cameras.${e}.${t}.stream`,this.updateStream))}if(this.state.rxData.camera){this.setState({loading:!0});const{instanceId:e,name:t}=h.getNameAndInstance(this.state.rxData.camera);this.useMessages?await this.props.context.socket.subscribeOnInstance(`cameras.${e}`,`startCamera/${t}`,{width:this.getImageWidth()},this.onCameras):await this.props.context.socket.subscribeState(`cameras.${e}.${t}.stream`,this.updateStream)}else{const e=this.videoRef.current;if(e){e.getContext("2d").clearRect(0,0,e.width,e.height)}}this.currentCam=this.state.rxData.camera}else if(this.currentCam){const{instanceId:e,name:t}=h.getNameAndInstance(this.currentCam);this.useMessages||(await this.props.context.socket.setState(`cameras.${e}.${t}.running`,{val:!1}),await this.props.context.socket.unsubscribeState(`cameras.${e}.${t}.stream`,this.updateStream)),this.currentCam=null}}else if(this.currentCam&&this.state.alive){const{instanceId:e,name:t}=h.getNameAndInstance(this.currentCam);this.useMessages?await this.props.context.socket.subscribeOnInstance(`cameras.${e}`,`startCamera/${t}`,{width:this.getImageWidth()},this.onCameras):await this.props.context.socket.setState(`cameras.${e}.${t}.running`,{val:!0,expire:30})}else if(this.currentCam&&!this.state.alive){const{instanceId:e,name:t}=h.getNameAndInstance(this.currentCam);this.useMessages||(await this.props.context.socket.setState(`cameras.${e}.${t}.running`,{val:!1}),await this.props.context.socket.unsubscribeState(`cameras.${e}.${t}.stream`,this.updateStream)),this.currentCam=null}}getImageWidth(e){var t;return(e=void 0===e?this.state.full:e)&&this.fullVideoRef.current?this.fullVideoRef.current.parentElement.clientWidth||0:(null===(t=this.videoRef.current)||void 0===t?void 0:t.parentElement.clientWidth)||0}async subscribeOnAlive(){const e=h.getNameAndInstance(this.state.rxData.camera);this.subsribedOnAlive!==(e?e.instanceId:null)&&(this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState(`system.adapter.cameras.${this.subsribedOnAlive}.alive`,this.onAliveChanged),this.subsribedOnAlive=""),e&&(this.props.context.socket.subscribeState(`system.adapter.cameras.${e.instanceId}.alive`,this.onAliveChanged),this.subsribedOnAlive=e.instanceId))}componentDidMount(){super.componentDidMount(),setTimeout((()=>this.propertiesUpdate()),100),this.subscribeOnAlive(),this.videoInterval=setInterval((()=>this.propertiesUpdate()),14e3)}async onRxDataChanged(){await this.subscribeOnAlive(),await this.propertiesUpdate()}componentWillUnmount(){if(super.componentWillUnmount(),this.videoInterval&&clearInterval(this.videoInterval),this.videoInterval=null,this.subsribedOnAlive&&(this.props.context.socket.unsubscribeState(`system.adapter.cameras.${this.subsribedOnAlive}.alive`,this.onAliveChanged),this.subsribedOnAlive=null),this.currentCam){const{instanceId:e,name:t}=h.getNameAndInstance(this.currentCam);this.useMessages&&this.props.context.socket.unsubscribeFromInstance(`cameras.${e}`,`startCamera/${t}`,this.onCameras).catch((e=>console.error(e)))}}renderDialog(){return this.state.full?(0,c.jsxs)(r.Dialog,{fullWidth:!0,maxWidth:"lg",open:!0,onClose:()=>this.setState({full:!1}),children:[(0,c.jsx)(r.DialogTitle,{children:this.state.rxData.widgetTitle}),(0,c.jsx)(r.DialogContent,{children:(0,c.jsx)("div",{style:l.imageContainer,children:(0,c.jsx)("canvas",{ref:this.fullVideoRef,style:l.fullCamera})})}),(0,c.jsx)(r.DialogActions,{children:(0,c.jsx)(r.Button,{onClick:e=>{e.stopPropagation(),e.preventDefault(),this.setState({full:!1})},startIcon:(0,c.jsx)(n.Close,{}),color:"primary",variant:"contained",children:o.A.t("Close")})})]}):null}renderWidgetBody(e){super.renderWidgetBody(e);const t=(0,c.jsxs)("div",{style:l.imageContainer,onClick:()=>this.setState({full:!0}),children:[this.state.loading&&this.state.alive&&(0,c.jsx)(r.CircularProgress,{style:l.progress}),this.state.alive?null:(0,c.jsx)("div",{style:{position:"absolute",top:0,left:0},children:o.A.t("Camera instance %s inactive",(this.state.rxData.camera||"").split("/")[0])}),(0,c.jsx)("canvas",{ref:this.videoRef,style:l.camera}),this.renderDialog()]});return this.state.rxData.noCard||e.widget.usedInWidget?t:this.wrapContent(t,null,{boxSizing:"border-box",paddingBottom:10,height:"100%"})}}const u=h},1153:(e,t,s)=>{var a=s(8437),i=Symbol.for("react.element"),r=Symbol.for("react.fragment"),n=Object.prototype.hasOwnProperty,o=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,s){var a,r={},l=null,d=null;for(a in void 0!==s&&(l=""+s),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)n.call(t,a)&&!c.hasOwnProperty(a)&&(r[a]=t[a]);if(e&&e.defaultProps)for(a in t=e.defaultProps)void 0===r[a]&&(r[a]=t[a]);return{$$typeof:i,type:e,key:l,ref:d,props:r,_owner:o.current}}t.jsx=l,t.jsxs=l},579:(e,t,s)=>{e.exports=s(1153)}}]);
//# sourceMappingURL=src_RtspCamera_jsx.e9338218.chunk.js.map